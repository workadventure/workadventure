# https://help.github.com/en/categories/automating-your-workflow-with-github-actions

name: "Continuous Integration"

on:
  push:
    branches:
      - master
      - develop
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  continuous-integration-play:
    name: "Continuous Integration Play"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install dependencies"
        run: npm ci --workspace=workadventure-play

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Generate i18n files"
        run: npm run typesafe-i18n
        working-directory: "play"

      - name: "Check translations completeness"
        run: |
          set -e
          cd play || exit 1
          
          HAS_ERRORS=0
          echo "=== RECENSEMENT COMPLET DES FICHIERS INCOMPLETS ==="
          echo ""
          echo "üìÅ D√©tection automatique des langues dans src/i18n/..."
          
          # D√©tecter toutes les langues (dossiers dans i18n, sauf en-US qui est la r√©f√©rence)
          LANGUAGES=$(find src/i18n -mindepth 1 -maxdepth 1 -type d -not -name "en-US" -exec basename {} \; | sort)
          
          # Compter le nombre de langues
          LANG_COUNT=$(echo "$LANGUAGES" | wc -l | tr -d ' ')
          echo "‚úÖ Langues d√©tect√©es: $LANG_COUNT"
          echo "   $(echo "$LANGUAGES" | tr '\n' ' ')"
          echo ""
          echo "üìÑ Fichier de r√©f√©rence: en-US"
          echo ""
          
          # D√©tecter tous les fichiers dans en-US
          REFERENCE_FILES=$(find src/i18n/en-US -maxdepth 1 -name "*.ts" -type f -exec basename {} .ts \; | sort)
          
          # Fonction Python pour extraire les cl√©s d'un fichier
          extract_keys() {
            local filepath="$1"
            python3 - "$filepath" << 'PYTHON_EOF'
          import re
          import sys
          import os
          
          # Get the filepath from command line argument
          if len(sys.argv) < 2:
              sys.exit(1)
          
          filepath = sys.argv[1]
          
          def extract_keys_from_file(filepath):
              """Extract all keys from a TypeScript translation file with their full path (recursive)"""
              if not os.path.exists(filepath):
                  return set()
              
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
              except Exception:
                  return set()
              
              # Remove single-line comments (but preserve line structure)
              lines = content.split('\n')
              cleaned_lines = []
              for line in lines:
                  # Remove comments, but keep the line structure
                  comment_pos = line.find('//')
                  if comment_pos >= 0:
                      # Check if // is inside a string
                      before_comment = line[:comment_pos]
                      quote_count = before_comment.count('"') + before_comment.count("'") + before_comment.count('`')
                      if quote_count % 2 == 0:  # Even number means we're outside strings
                          line = line[:comment_pos]
                  cleaned_lines.append(line)
              content = '\n'.join(cleaned_lines)
              
              # Remove multi-line comments
              content = re.sub(r'/\*.*?\*/', '', content, flags=re.DOTALL)
              
              # Extract keys with their full path recursively
              keys = set()
              lines = content.split('\n')
              current_path = []
              indent_stack = []
              
              i = 0
              while i < len(lines):
                  line = lines[i]
                  stripped = line.strip()
                  
                  # Skip imports, const declarations, export, etc.
                  if not stripped or \
                     stripped.startswith('import') or \
                     (stripped.startswith('const') and '=' in stripped and ':' not in stripped.split('=')[0]) or \
                     stripped.startswith('export') or \
                     stripped.startswith('type'):
                      i += 1
                      continue
                  
                  # Skip standalone braces
                  if stripped == '{' and not any(c.isalnum() or c in '_:' for c in line[:line.find('{')]):
                      i += 1
                      continue
                  
                  # Calculate indentation (spaces only, not tabs)
                  indent = len(line) - len(line.lstrip())
                  
                  # Match key: pattern (word followed by colon)
                  # This regex matches: key: or "key": or 'key':
                  match = re.match(r'^\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*:', line)
                  if match:
                      key = match.group(1)
                      
                      # Update path based on indentation
                      # Remove deeper levels when we go back to a shallower level
                      while indent_stack and len(indent_stack) > 0 and indent_stack[-1] >= indent:
                          indent_stack.pop()
                          if current_path:
                              current_path.pop()
                      
                      current_path.append(key)
                      indent_stack.append(indent)
                      
                      # Create full path
                      full_path = '.'.join(current_path)
                      keys.add(full_path)
                  
                  # Handle closing braces - check if this line closes an object
                  if stripped == '}' or stripped == '};' or (stripped.endswith('},') and not stripped.startswith('}')):
                      # Find the matching opening brace by looking at indentation
                      if indent_stack and len(indent_stack) > 0:
                          # We're closing an object at this indentation level
                          # Pop until we find the matching level
                          while indent_stack and indent_stack[-1] >= indent:
                              indent_stack.pop()
                              if current_path:
                                  current_path.pop()
                  
                  i += 1
              
              return keys
          
          keys = extract_keys_from_file(filepath)
          
          # Output keys one per line
          for key in sorted(keys):
              print(key)
          PYTHON_EOF
          }
          
          # Parcourir chaque fichier de r√©f√©rence
          for file in $REFERENCE_FILES; do
            ref_file="src/i18n/en-US/$file.ts"
            
            # V√©rifier que le fichier existe
            if [ ! -f "$ref_file" ]; then
              continue
            fi
            
            # Extraire les cl√©s de r√©f√©rence
            ref_keys=$(extract_keys "$ref_file")
            ref_key_count=$(echo "$ref_keys" | grep -v '^$' | wc -l | tr -d ' ')
            if [ -z "$ref_key_count" ] || [ "$ref_key_count" = "0" ]; then
              ref_key_count=0
            fi
            
            # Ignorer les fichiers vides
            if [ "$ref_key_count" -eq 0 ]; then
              continue
            fi
            
            echo "üìÑ $file.ts (en-US: $ref_key_count cl√©s):"
            incomplete_found=false
            
            # V√©rifier chaque langue d√©tect√©e
            for lang in $LANGUAGES; do
              lang_file="src/i18n/$lang/$file.ts"
              
              if [ ! -f "$lang_file" ]; then
                echo "  ‚ùå $lang: FICHIER MANQUANT"
                incomplete_found=true
                HAS_ERRORS=1
              else
                # Extraire les cl√©s de la langue
                lang_keys=$(extract_keys "$lang_file")
                lang_key_count=$(echo "$lang_keys" | grep -v '^$' | wc -l | tr -d ' ')
                if [ -z "$lang_key_count" ] || [ "$lang_key_count" = "0" ]; then
                  lang_key_count=0
                fi
                
                # Comparer les cl√©s
                missing_keys=$(comm -23 <(echo "$ref_keys" | sort) <(echo "$lang_keys" | sort) 2>/dev/null)
                missing_count=$(echo "$missing_keys" | grep -v '^$' | wc -l | tr -d ' ')
                if [ -z "$missing_count" ] || [ "$missing_count" = "0" ]; then
                  missing_count=0
                fi
                
                if [ "$missing_count" -gt 0 ] && [ "$ref_key_count" -gt 0 ]; then
                  percentage=$((lang_key_count * 100 / ref_key_count))
                  echo "  ‚ö†Ô∏è  $lang: $lang_key_count/$ref_key_count cl√©s ($percentage% complet, $missing_count cl√©(s) manquante(s))"
                  echo "$missing_keys" | head -15 | while read -r key; do
                    echo "     - $key"
                  done
                  if [ "$missing_count" -gt 15 ]; then
                    remaining=$((missing_count - 15))
                    echo "     ... et $remaining autre(s) cl√©(s)"
                  fi
                  incomplete_found=true
                  HAS_ERRORS=1
                else
                  echo "  ‚úÖ $lang: Toutes les cl√©s pr√©sentes"
                fi
              fi
            done
            
            if [ "$incomplete_found" = false ]; then
              echo "  ‚úÖ Toutes les langues compl√®tes"
            fi
            echo ""
          done
          
          echo "=== R√âSUM√â PAR LANGUE ==="
          echo ""
          for lang in $LANGUAGES; do
            total_files=0
            complete_files=0
            missing_files=0
            incomplete_files=0
            
            for file in $REFERENCE_FILES; do
              ref_file="src/i18n/en-US/$file.ts"
              lang_file="src/i18n/$lang/$file.ts"
              
              if [ ! -f "$ref_file" ]; then
                continue
              fi
              
              # V√©rifier les cl√©s uniquement
              ref_keys=$(extract_keys "$ref_file")
              ref_key_count=$(echo "$ref_keys" | grep -v '^$' | wc -l | tr -d ' ')
              if [ -z "$ref_key_count" ] || [ "$ref_key_count" = "0" ]; then
                ref_key_count=0
              fi
              
              if [ "$ref_key_count" -eq 0 ]; then
                continue
              fi
              
              total_files=$((total_files + 1))
              
              if [ ! -f "$lang_file" ]; then
                missing_files=$((missing_files + 1))
              else
                # V√©rifier les cl√©s
                lang_keys=$(extract_keys "$lang_file")
                missing_keys=$(comm -23 <(echo "$ref_keys" | sort) <(echo "$lang_keys" | sort) 2>/dev/null)
                missing_count=$(echo "$missing_keys" | grep -v '^$' | wc -l | tr -d ' ')
                if [ -z "$missing_count" ] || [ "$missing_count" = "0" ]; then
                  missing_count=0
                fi
                
                if [ "$missing_count" -gt 0 ]; then
                  incomplete_files=$((incomplete_files + 1))
                else
                  complete_files=$((complete_files + 1))
                fi
              fi
            done
            
            if [ "$total_files" -gt 0 ]; then
              completion_rate=$((complete_files * 100 / total_files))
              echo "üåç $lang: $complete_files/$total_files fichiers complets ($completion_rate%)"
              if [ "$missing_files" -gt 0 ]; then
                echo "   ‚ùå $missing_files fichier(s) manquant(s)"
                HAS_ERRORS=1
              fi
              if [ "$incomplete_files" -gt 0 ]; then
                echo "   ‚ö†Ô∏è  $incomplete_files fichier(s) incomplet(s)"
                HAS_ERRORS=1
              fi
            fi
          done
          
          echo ""
          if [ "$HAS_ERRORS" -eq 1 ]; then
            echo "‚ùå ERREUR: Des traductions sont incompl√®tes ou manquantes !"
            echo "   Veuillez compl√©ter les fichiers de traduction avant de continuer."
            exit 1
          else
            echo "‚úÖ Toutes les traductions sont compl√®tes !"
          fi
        working-directory: "play"

      - name: "Build"
        run: npm run build
        env:
          PUSHER_URL: "//localhost:3000"
          ADMIN_URL: "//localhost:80"
          # upgrade RAM available to 16GB
          NODE_OPTIONS: --max-old-space-size=16384
        working-directory: "play"

      - name: "Build iframe-api"
        run: npm run build-iframe-api
        working-directory: "play"

      - name: "Typecheck"
        run: npm run typecheck
        working-directory: "play"

      - name: "Svelte check"
        run: npm run svelte-check
        working-directory: "play"

      - name: "Lint"
        run: npm run lint
        working-directory: "play"

      - name: "Pretty"
        run: npm run pretty-check
        working-directory: "play"

      - name: "Unit tests"
        run: npm test
        working-directory: "play"

  continuous-integration-back:
    name: "Continuous Integration Back"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"


      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install dependencies"
        run: npm ci --workspace=workadventureback

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Typecheck"
        run: npm run typecheck
        working-directory: "back"

      - name: "Lint"
        run: npm run lint
        working-directory: "back"

      - name: "Unit tests"
        run: npm test
        working-directory: "back"

      - name: "Prettier"
        run: npm run pretty-check
        working-directory: "back"

  continuous-integration-uploader:
    name: "Continuous Integration Uploader"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"


      - name: "Install dependencies"
        run: npm ci --workspace=workadventureuploader

      - name: "Lint"
        run: npm run lint
        working-directory: "uploader"

      - name: "jest"
        run: npm test
        working-directory: "uploader"

  continuous-integration-lib-map-editor:
    name: "Continuous Integration Map Editor Library"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install dependencies"
        run: npm ci --workspace=@workadventure/map-editor

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Typecheck"
        run: npm run typecheck
        working-directory: "libs/map-editor"

      - name: "Lint"
        run: npm run lint
        working-directory: "libs/map-editor"

      - name: "Pretty"
        run: npm run pretty-check
        working-directory: "libs/map-editor"

      - name: "vitest"
        run: npm test
        working-directory: "libs/map-editor"

      - name: "Check WAM Jsonschema is in sync of Zod"
        run: |
          npm run export-json-schema
          echo "Check if there is a diff between the generated json schema and the one in the repo"
          echo "If there is a diff, you need to run 'npm run export-json-schema' and commit the changes"
          git diff --exit-code
        working-directory: "libs/map-editor"

  continuous-integration-lib-store-utils:
    name: "Continuous Integration Store Utils"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install dependencies"
        run: npm ci --workspace=@workadventure/store-utils

      - name: "Pretty Check"
        run: npm run pretty-check
        working-directory: "libs/store-utils"

      - name: "ESLint"
        run: npm run lint
        working-directory: "libs/store-utils"

      - name: "Svelte Check"
        run: npm run svelte-check
        working-directory: "libs/store-utils"

      - name: "Typecheck"
        run: npm run typecheck
        working-directory: "libs/store-utils"

      - name: "vitest"
        run: npm test
        working-directory: "libs/store-utils"

  continuous-integration-shared-utils:
    name: "Continuous Integration shared-utils Library"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install dependencies"
        run: npm ci --workspace=@workadventure/shared-utils

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Typecheck"
        run: npm run typecheck
        working-directory: "libs/shared-utils"

      - name: "Lint"
        run: npm run lint
        working-directory: "libs/shared-utils"

      - name: "Pretty"
        run: npm run pretty-check
        working-directory: "libs/shared-utils"

      - name: "vitest"
        run: npm test
        working-directory: "libs/shared-utils"

  continuous-integration-map-storage:
    name: "Continuous Integration Map Storage"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"


      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install dependencies"
        run: npm ci --workspace=map-storage

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Typecheck"
        run: npm run typecheck
        working-directory: "map-storage"

      - name: "Lint"
        run: npm run lint
        working-directory: "map-storage"

      - name: "Tests"
        run: npm run test
        working-directory: "map-storage"

      - name: "Prettier"
        run: npm run pretty-check
        working-directory: "map-storage"

  check-env-docs:
    name: "Check Environment Variables Documentation"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Install tool dependencies"
        run: npm ci --workspace=@workadventure/generate-env-docs

      - name: "Check documentation is up to date"
        run: npm run check-env-docs

  continuous-integration-room-api-client:
    name: "Continuous Integration Room API Client"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: '3.x'

      - name: "Install ESLint config dependencies"
        run: npm ci --workspace=@workadventure/eslint-config

      - name: "Install dependencies"
        run: npm ci
        working-directory: "libs/room-api-clients/room-api-client-js"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "libs/room-api-clients/room-api-client-js"

      - name: "Build"
        run: npm run build
        working-directory: "libs/room-api-clients/room-api-client-js"

      - name: "Lint"
        run: npm run lint
        working-directory: "libs/room-api-clients/room-api-client-js"

      - name: "Pretty"
        run: npm run pretty-check
        working-directory: "libs/room-api-clients/room-api-client-js"

  continuous-integration-desktop:
    name: "Continuous Integration Desktop"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
          cache-dependency-path: '**/yarn.lock'

      - name: "Install dependencies"
        run: yarn install
        working-directory: "desktop/electron"

      - name: "Build"
        run: yarn run build
        working-directory: "desktop/electron"

      - name: "Typecheck"
        run: yarn run typecheck
        working-directory: "desktop/electron"

      - name: "Lint"
        run: yarn run lint
        working-directory: "desktop/electron"

      - name: "Jasmine"
        run: yarn run test
        working-directory: "desktop/electron"

      - name: "Prettier"
        run: yarn run pretty-check
        working-directory: "desktop/electron"

  continuous-integration-desktop-local-app:
    name: "Continuous Integration Desktop Local App"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
          cache-dependency-path: '**/yarn.lock'


      - name: "Install dependencies"
        run: yarn install
        working-directory: "desktop/local-app"

      - name: "Build"
        run: yarn build
        working-directory: "desktop/local-app"

      - name: "Typecheck"
        run: yarn check
        working-directory: "desktop/local-app"

      - name: "Lint"
        run: yarn lint
        working-directory: "desktop/local-app"

      - name: "Jasmine"
        run: yarn test
        working-directory: "desktop/local-app"

      - name: "Prettier"
        run: yarn pretty-check
        working-directory: "desktop/local-app"

  continuous-integration-end-to-end-tests:
    name: "Continuous Integration checking End To End tests"

    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5"

      - name: "Setup NodeJS"
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci --workspace=workadventure-e2e-tests --workspace=workadventure-play

      - name: "Install messages dependencies"
        run: npm ci
        working-directory: "messages"

      - name: "Build proto messages"
        run: npm run ts-proto
        working-directory: "messages"

      - name: "Install Room API client dependencies"
        run: npm ci
        working-directory: "libs/room-api-clients/room-api-client-js"

      - name: "Build Room API proto files"
        run: npm run ts-proto
        working-directory: "libs/room-api-clients/room-api-client-js"

      - name: "Build API typings"
        run: npm run build-typings
        working-directory: "play"

      - name: "Lint"
        run: npm run lint
        working-directory: "tests"
