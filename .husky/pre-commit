#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Fonction pour v√©rifier la compl√©tude des traductions
check_translations() {
  cd play || exit 1
  
  HAS_ERRORS=0
  echo "=== RECENSEMENT COMPLET DES FICHIERS INCOMPLETS ==="
  echo ""
  echo "üìÅ D√©tection automatique des langues dans src/i18n/..."
  
  # D√©tecter toutes les langues (dossiers dans i18n, sauf en-US qui est la r√©f√©rence)
  LANGUAGES=$(find src/i18n -mindepth 1 -maxdepth 1 -type d -not -name "en-US" -exec basename {} \; | sort)
  
  # Compter le nombre de langues
  LANG_COUNT=$(echo "$LANGUAGES" | wc -l | tr -d ' ')
  echo "‚úÖ Langues d√©tect√©es: $LANG_COUNT"
  echo "   $(echo "$LANGUAGES" | tr '\n' ' ')"
  echo ""
  echo "üìÑ Fichier de r√©f√©rence: en-US"
  echo ""
  
  # D√©tecter tous les fichiers dans en-US
  REFERENCE_FILES=$(find src/i18n/en-US -maxdepth 1 -name "*.ts" -type f -exec basename {} .ts \; | sort)
  
  # Parcourir chaque fichier de r√©f√©rence
  for file in $REFERENCE_FILES; do
    ref_file="src/i18n/en-US/$file.ts"
    
    # V√©rifier que le fichier existe
    if [ ! -f "$ref_file" ]; then
      continue
    fi
    
    # Compter les lignes du fichier de r√©f√©rence
    en_lines=$(wc -l < "$ref_file" 2>/dev/null || echo "0")
    
    # Ignorer les fichiers vides
    if [ "$en_lines" -eq 0 ]; then
      continue
    fi
    
    echo "üìÑ $file.ts (en-US: $en_lines lignes):"
    incomplete_found=false
    
    # V√©rifier chaque langue d√©tect√©e
    for lang in $LANGUAGES; do
      lang_file="src/i18n/$lang/$file.ts"
      
      if [ ! -f "$lang_file" ]; then
        echo "  ‚ùå $lang: FICHIER MANQUANT"
        incomplete_found=true
        HAS_ERRORS=1
      else
        lang_lines=$(wc -l < "$lang_file" 2>/dev/null || echo "0")
        threshold=$((en_lines * 70 / 100))
        
        if [ "$lang_lines" -lt "$threshold" ]; then
          percentage=$((lang_lines * 100 / en_lines))
          missing=$((en_lines - lang_lines))
          echo "  ‚ö†Ô∏è  $lang: $lang_lines lignes ($percentage% complet, manque ~$missing lignes)"
          incomplete_found=true
          HAS_ERRORS=1
        fi
      fi
    done
    
    if [ "$incomplete_found" = false ]; then
      echo "  ‚úÖ Toutes les langues compl√®tes"
    fi
    echo ""
  done
  
  echo "=== R√âSUM√â PAR LANGUE ==="
  echo ""
  for lang in $LANGUAGES; do
    total_files=0
    complete_files=0
    missing_files=0
    incomplete_files=0
    
    for file in $REFERENCE_FILES; do
      ref_file="src/i18n/en-US/$file.ts"
      lang_file="src/i18n/$lang/$file.ts"
      
      if [ ! -f "$ref_file" ]; then
        continue
      fi
      
      en_lines=$(wc -l < "$ref_file" 2>/dev/null || echo "0")
      if [ "$en_lines" -eq 0 ]; then
        continue
      fi
      
      total_files=$((total_files + 1))
      
      if [ ! -f "$lang_file" ]; then
        missing_files=$((missing_files + 1))
      else
        lang_lines=$(wc -l < "$lang_file" 2>/dev/null || echo "0")
        threshold=$((en_lines * 70 / 100))
        
        if [ "$lang_lines" -lt "$threshold" ]; then
          incomplete_files=$((incomplete_files + 1))
        else
          complete_files=$((complete_files + 1))
        fi
      fi
    done
    
    if [ "$total_files" -gt 0 ]; then
      completion_rate=$((complete_files * 100 / total_files))
      echo "üåç $lang: $complete_files/$total_files fichiers complets ($completion_rate%)"
      if [ "$missing_files" -gt 0 ]; then
        echo "   ‚ùå $missing_files fichier(s) manquant(s)"
        HAS_ERRORS=1
      fi
      if [ "$incomplete_files" -gt 0 ]; then
        echo "   ‚ö†Ô∏è  $incomplete_files fichier(s) incomplet(s)"
        HAS_ERRORS=1
      fi
    fi
  done
  
  echo ""
  if [ "$HAS_ERRORS" -eq 1 ]; then
    echo "‚ùå ERREUR: Des traductions sont incompl√®tes ou manquantes !"
    echo "   Veuillez compl√©ter les fichiers de traduction avant de continuer."
    exit 1
  else
    echo "‚úÖ Toutes les traductions sont compl√®tes !"
  fi
}

(
cd messages || exit
npm run precommit
)
(
cd play || exit
npm run precommit
)
(
check_translations
)
(
cd back || exit
npm run precommit
)
(
cd map-storage || exit
npm run precommit
)
(
cd tests || exit
npm run precommit
)
(
cd libs/map-editor || exit
npm run precommit
)
(
cd libs/shared-utils || exit
npm run precommit
)
(
cd libs/store-utils || exit
npm run precommit
)
(
cd contrib/tools/generate-env-docs || exit
npm run generate
)
