services:
  livekit:
    image: livekit/livekit-server:v1.8.4
    command: --config /etc/livekit/config.yaml
    ports:
      - "7880:7880" # HTTP API
      - "7881:7881/udp" # WebRTC UDP
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.livekit.rule=Host(`livekit.workadventure.localhost`)"
      - "traefik.http.routers.livekit.entryPoints=web"
      - "traefik.http.services.livekit.loadbalancer.server.port=7880"
      - "traefik.udp.routers.livekit-udp.entrypoints=udp"
      - "traefik.udp.routers.livekit-udp.service=livekit-udp"
      - "traefik.udp.services.livekit-udp.loadbalancer.server.port=7881"
    volumes:
      - ./livekit-config.yaml:/etc/livekit/config.yaml
    depends_on:
      redis:
        condition: service_started

  egress:
    image: livekit/egress:v1.9.0
    #restart: unless-stopped
    ports:
      - "8080:8080" # Egress API
      - "8081:8081" # Egress Health
      - "7980:7980" # Template port
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.egress.rule=Host(`egress.workadventure.localhost`)"
      - "traefik.http.routers.egress.entryPoints=web"
      - "traefik.http.services.egress.loadbalancer.server.port=8080"
    environment:
      EGRESS_CONFIG_FILE: /etc/egress/config.yaml
      DISABLE_CUDA: "true"
      DISABLE_NVENC: "true"
      EGRESS_OUTPUT_DIR: "/out"

    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./egress-config.yaml:/etc/egress/config.yaml
      - ./out:/out:rw
      - /tmp:/tmp:rw
    cap_add:
      - SYS_ADMIN
    privileged: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    depends_on:
      redis:
        condition: service_started
      livekit:
        condition: service_started

  rustfs-livekit:
    image: rustfs/rustfs:1.0.0-alpha.83
    command: ["/data"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rustfs-livekit.rule=Host(`rustfs-livekit.workadventure.localhost`)"
      - "traefik.http.routers.rustfs-livekit.entryPoints=web"
      - "traefik.http.services.rustfs-livekit.loadbalancer.server.port=9001"
      - "traefik.http.routers.rustfs-livekit.service=rustfs-livekit"
      - "traefik.http.routers.cdn-livekit.rule=Host(`cdn-livekit.workadventure.localhost`)"
      - "traefik.http.routers.cdn-livekit.entryPoints=web"
      - "traefik.http.services.cdn-livekit.loadbalancer.server.port=9000"
      - "traefik.http.routers.cdn-livekit.service=cdn-livekit"
    environment:
      RUSTFS_ACCESS_KEY: "rustfs-access-key"
      RUSTFS_SECRET_KEY: "rustfs-secret-access-key"
      RUSTFS_CONSOLE_ENABLE: "true"

  rustfs-livekit-init:
    image: amazon/aws-cli:2.31.1
    depends_on:
      rustfs-livekit:
        condition: service_started
    entrypoint: ["/bin/sh", "-ec"]
    command:
      - |
        until aws --endpoint-url http://rustfs-livekit:9000 s3api list-buckets >/dev/null 2>&1; do
          sleep 1
        done
        aws --endpoint-url http://rustfs-livekit:9000 s3api head-bucket --bucket livekit-recording >/dev/null 2>&1 \
          || aws --endpoint-url http://rustfs-livekit:9000 s3api create-bucket \
               --bucket livekit-recording \
               --create-bucket-configuration LocationConstraint=eu-west-1
    environment:
      AWS_ACCESS_KEY_ID: "rustfs-access-key"
      AWS_SECRET_ACCESS_KEY: "rustfs-secret-access-key"
      AWS_DEFAULT_REGION: "eu-west-1"

  reverse-proxy:
    networks:
      default:
        aliases:
          - "livekit.workadventure.localhost"
          - "egress.workadventure.localhost"

  back:
    depends_on:
      rustfs-livekit-init:
        condition: service_completed_successfully
    environment:
      LIVEKIT_HOST: "$LIVEKIT_HOST"
      LIVEKIT_API_KEY: "$LIVEKIT_API_KEY"
      LIVEKIT_API_SECRET: "$LIVEKIT_API_SECRET"
      MAX_USERS_FOR_WEBRTC: "$MAX_USERS_FOR_WEBRTC"
      LIVEKIT_RECORDING_S3_ENDPOINT: "$LIVEKIT_RECORDING_S3_ENDPOINT"
      LIVEKIT_RECORDING_S3_ACCESS_KEY: "$LIVEKIT_RECORDING_S3_ACCESS_KEY"
      LIVEKIT_RECORDING_S3_SECRET_KEY: "$LIVEKIT_RECORDING_S3_SECRET_KEY"
      LIVEKIT_RECORDING_S3_REGION: "$LIVEKIT_RECORDING_S3_REGION"
      LIVEKIT_RECORDING_S3_BUCKET: "$LIVEKIT_RECORDING_S3_BUCKET"
  play:
    environment:
      LIVEKIT_RECORDING_S3_ENDPOINT: "$LIVEKIT_RECORDING_S3_ENDPOINT"
      LIVEKIT_RECORDING_S3_CDN_ENDPOINT: "$LIVEKIT_RECORDING_S3_CDN_ENDPOINT"
      LIVEKIT_RECORDING_S3_ACCESS_KEY: "$LIVEKIT_RECORDING_S3_ACCESS_KEY"
      LIVEKIT_RECORDING_S3_SECRET_KEY: "$LIVEKIT_RECORDING_S3_SECRET_KEY"
      LIVEKIT_RECORDING_S3_REGION: "$LIVEKIT_RECORDING_S3_REGION"
      LIVEKIT_RECORDING_S3_BUCKET: "$LIVEKIT_RECORDING_S3_BUCKET"
