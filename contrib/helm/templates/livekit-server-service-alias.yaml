{{- if and .Values.livekit.enabled .Values.livekit.egress.enabled -}}
{{- $livekitEgress := index .Values "livekit-egress" | default dict -}}
{{- $egressConfig := index $livekitEgress "egress" | default dict -}}
{{- $wsURL := index $egressConfig "ws_url" | default "" -}}
{{- if eq $wsURL "ws://workadventure-livekit-server:80" -}}
{{- $livekitServer := index .Values "livekit-server" | default dict -}}
{{- $loadBalancer := index $livekitServer "loadBalancer" | default dict -}}
{{- $servicePort := index $loadBalancer "servicePort" | default 80 -}}
{{- $livekitServiceName := include "workadventure.livekitServiceName" . -}}
{{- $externalName := ternary $livekitServiceName (printf "%s.%s.svc.cluster.local" $livekitServiceName .Release.Namespace) (contains "." $livekitServiceName) -}}
---
apiVersion: v1
kind: Service
metadata:
  # Keep a stable service DNS name for the default LiveKit Egress ws_url,
  # while the upstream livekit-server service keeps its release-based name.
  name: workadventure-livekit-server
  labels:
    {{- include "workadventure.labels" . | nindent 4 }}
spec:
  type: ExternalName
  externalName: {{ $externalName | quote }}
  ports:
    - name: http
      port: {{ $servicePort }}
      targetPort: {{ $servicePort }}
      protocol: TCP
{{- end -}}
{{- end -}}
