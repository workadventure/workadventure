{{- if .Values.livekit.enabled -}}
{{- $credentials := .Values.livekit.credentials | default dict -}}
{{- $manageSecret := true -}}
{{- if hasKey $credentials "manageSecret" -}}
{{- $manageSecret = $credentials.manageSecret -}}
{{- end -}}
{{- if $manageSecret -}}
{{- $secretName := include "workadventure.livekitCredentialsSecretName" . -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $commonEnv := .Values.commonEnv | default dict -}}
{{- $backEnv := .Values.back.env | default dict -}}
{{- $commonSecretEnv := .Values.commonSecretEnv | default dict -}}
{{- $backSecretEnv := .Values.back.secretEnv | default dict -}}
{{- $apiKey := index $credentials "apiKey" | default "" -}}
{{- if and (not $apiKey) (hasKey $backSecretEnv "LIVEKIT_API_KEY") -}}
{{- $apiKey = index $backSecretEnv "LIVEKIT_API_KEY" -}}
{{- end -}}
{{- if and (not $apiKey) (hasKey $commonSecretEnv "LIVEKIT_API_KEY") -}}
{{- $apiKey = index $commonSecretEnv "LIVEKIT_API_KEY" -}}
{{- end -}}
{{- if and (not $apiKey) (hasKey $backEnv "LIVEKIT_API_KEY") -}}
{{- $apiKey = index $backEnv "LIVEKIT_API_KEY" -}}
{{- end -}}
{{- if and (not $apiKey) (hasKey $commonEnv "LIVEKIT_API_KEY") -}}
{{- $apiKey = index $commonEnv "LIVEKIT_API_KEY" -}}
{{- end -}}
{{- if and (not $apiKey) $existingSecret (hasKey $existingSecret.data "LIVEKIT_API_KEY") -}}
{{- $apiKey = (index $existingSecret.data "LIVEKIT_API_KEY" | b64dec) -}}
{{- end -}}
{{- if not $apiKey -}}
{{- $apiKey = randAlphaNum 16 -}}
{{- end -}}

{{- $apiSecret := index $credentials "apiSecret" | default "" -}}
{{- if and (not $apiSecret) (hasKey $backSecretEnv "LIVEKIT_API_SECRET") -}}
{{- $apiSecret = index $backSecretEnv "LIVEKIT_API_SECRET" -}}
{{- end -}}
{{- if and (not $apiSecret) (hasKey $commonSecretEnv "LIVEKIT_API_SECRET") -}}
{{- $apiSecret = index $commonSecretEnv "LIVEKIT_API_SECRET" -}}
{{- end -}}
{{- if and (not $apiSecret) (hasKey $backEnv "LIVEKIT_API_SECRET") -}}
{{- $apiSecret = index $backEnv "LIVEKIT_API_SECRET" -}}
{{- end -}}
{{- if and (not $apiSecret) (hasKey $commonEnv "LIVEKIT_API_SECRET") -}}
{{- $apiSecret = index $commonEnv "LIVEKIT_API_SECRET" -}}
{{- end -}}
{{- if and (not $apiSecret) $existingSecret (hasKey $existingSecret.data "LIVEKIT_API_SECRET") -}}
{{- $apiSecret = (index $existingSecret.data "LIVEKIT_API_SECRET" | b64dec) -}}
{{- end -}}
{{- if not $apiSecret -}}
{{- $apiSecret = randAlphaNum 32 -}}
{{- end -}}

{{- $livekitServer := index .Values "livekit-server" | default dict -}}
{{- $livekitConfig := index $livekitServer "livekit" | default dict -}}
{{- $keyFile := index $livekitConfig "key_file" | default "keys.yaml" -}}
{{- if not (regexMatch "^[A-Za-z0-9._-]+$" $keyFile) -}}
{{- fail "livekit-server.livekit.key_file must contain only letters, numbers, dots, dashes, and underscores" -}}
{{- end -}}

---
kind: Secret
apiVersion: v1
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "workadventure.labels" . | nindent 4 }}
type: Opaque
data:
  LIVEKIT_API_KEY: {{ $apiKey | b64enc | quote }}
  LIVEKIT_API_SECRET: {{ $apiSecret | b64enc | quote }}
  {{ $keyFile }}: {{ (toYaml (dict $apiKey $apiSecret)) | b64enc | quote }}
{{- end -}}
{{- end -}}
