version: "3.6"
services:
  reverse-proxy:
    networks:
      default:
        aliases:
          - "livekit.workadventure.localhost"
          - "egress.workadventure.localhost"
    depends_on:
      play:
        condition: service_healthy
      back:
        condition: service_healthy
  maps:
    image: thecodingmachine/php:8.1-v4-apache-node12
    environment:
      FRONT_URL: https://play.workadventure.localhost
      #APACHE_DOCUMENT_ROOT: dist/
      #APACHE_EXTENSIONS: headers
      #APACHE_EXTENSION_HEADERS: 1
      STARTUP_COMMAND_0: sudo a2enmod headers
      STARTUP_COMMAND_1: yarn install
    volumes:
      - ../../maps:/var/www/html
    labels:
      traefik.enable: "true"
      traefik.http.routers.maps.rule: "Host(`maps.workadventure.localhost`)"
      traefik.http.routers.maps.entryPoints: "web,traefik"
      traefik.http.services.maps.loadbalancer.server.port: "80"
      traefik.http.routers.maps-ssl.rule: "Host(`maps.workadventure.localhost`)"
      traefik.http.routers.maps-ssl.entryPoints: "websecure"
      traefik.http.routers.maps-ssl.service: "maps"
      traefik.http.routers.maps-ssl.tls: "true"
      traefik.http.routers.maps-ssl.tls.certresolver: "myresolver"
  back:
    environment:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
  livekit:
    image: livekit/livekit-server:v1.8.4
    command: --config /etc/livekit/config.yaml
    ports:
      - "7881:7881" # WebRTC TCP
      - "7882:7882/udp" # WebRTC UDP
    labels:
      traefik.enable: "true"
      traefik.http.routers.livekit.rule: "Host(`livekit.workadventure.localhost`)"
      traefik.http.routers.livekit.entryPoints: "web"
      traefik.http.routers.livekit.service: livekit
      traefik.http.routers.livekit-ssl.rule: "Host(`livekit.workadventure.localhost`)"
      traefik.http.routers.livekit-ssl.entryPoints: "websecure"
      traefik.http.routers.livekit-ssl.service: "livekit"
      traefik.http.routers.livekit-ssl.tls: "true"
      traefik.http.routers.livekit-ssl.tls.certresolver: "myresolver"
      traefik.http.services.livekit.loadbalancer.server.port: "7880"
      traefik.udp.routers.livekit-udp.entrypoints: udp
      traefik.udp.routers.livekit-udp.service: livekit-udp
      traefik.udp.services.livekit-udp.loadbalancer.server.port: 7881

    volumes:
      - ./tests/livekit-config.yaml:/etc/livekit/config.yaml
    depends_on:
      redis:
        condition: service_started

  egress:
    image: livekit/egress:v1.9.0
    #restart: unless-stopped
    environment:
      EGRESS_CONFIG_FILE: /etc/egress/config.yaml

    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./egress-config.yaml:/etc/egress/config.yaml
      - ./out:/out:rw
      - /tmp:/tmp:rw
    cap_add:
      - SYS_ADMIN
    privileged: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    depends_on:
      redis:
        condition: service_started
      livekit:
        condition: service_started

  minio-livekit:
    image: bitnamilegacy/minio:2025.4.22
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-livekit.rule=Host(`minio-livekit.workadventure.localhost`)"
      - "traefik.http.routers.minio-livekit.entryPoints=web"
      - "traefik.http.services.minio-livekit.loadbalancer.server.port=9001"
      - "traefik.http.routers.minio-livekit.service=minio-livekit"
      - "traefik.http.routers.cdn-livekit.rule=Host(`cdn-livekit.workadventure.localhost`)"
      - "traefik.http.routers.cdn-livekit.entryPoints=web"
      - "traefik.http.services.cdn-livekit.loadbalancer.server.port=9000"
      - "traefik.http.routers.cdn-livekit.service=cdn-livekit"

      - "traefik.http.routers.minio-livekit-ssl.rule=Host(`minio-livekit.workadventure.localhost`)"
      - "traefik.http.routers.minio-livekit-ssl.entryPoints=websecure"
      - "traefik.http.routers.minio-livekit-ssl.service=minio-livekit"
      - "traefik.http.routers.minio-livekit-ssl.tls=true"
      - "traefik.http.routers.minio-livekit-ssl.tls.certresolver=myresolver"

      - "traefik.http.routers.cdn-livekit-ssl.rule=Host(`cdn-livekit.workadventure.localhost`)"
      - "traefik.http.routers.cdn-livekit-ssl.entryPoints=websecure"
      - "traefik.http.routers.cdn-livekit-ssl.service=cdn-livekit"
      - "traefik.http.routers.cdn-livekit-ssl.tls=true"
      - "traefik.http.routers.cdn-livekit-ssl.tls.certresolver=myresolver"
    environment:
      MINIO_ROOT_USER: "minio-access-key"
      MINIO_ROOT_PASSWORD: "minio-secret-access-key"
      MINIO_DEFAULT_BUCKETS: "livekit-recording:public"
      MINIO_SITE_REGION: "eu-west-1"

